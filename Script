-- ==========================================================
-- PROYECTO: AKAY LAUNCHER
-- AUTOR: Aaron Del Coso Ridocci
-- DESCRIPCIÓN: Script de generación de BBDD y datos de prueba
-- ==========================================================

-- 1. PREPARACIÓN DEL ENTORNO
-- ----------------------------------------------------------
-- Si la base de datos ya existe, la eliminamos para empezar de cero (limpieza)
DROP DATABASE IF EXISTS akay_data;

-- Creamos la base de datos nueva
CREATE DATABASE akay_data;

-- Seleccionamos la base de datos para ejecutar las consultas en ella
USE akay_data;

-- ==========================================================
-- 2. DEFINICIÓN DE ESTRUCTURAS (DDL)
-- ==========================================================

-- TABLA USUARIOS: Gestiona el acceso, roles y sistema de sanciones
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100),
    apellidos VARCHAR(100),
    username VARCHAR(50) UNIQUE,      -- El nombre de usuario no puede repetirse
    password VARCHAR(255),            -- Contraseña (idealmente debería ser Hash)
    email VARCHAR(100),
    telefono VARCHAR(20),
    cp VARCHAR(10),
    rol VARCHAR(20) DEFAULT 'USER',   -- Roles: USER, ADMIN, SUPERADMIN, GAME_ADMIN...
    activo TINYINT(1) DEFAULT 1,      -- 1 = Activo, 0 = Baneado
    grado_baneo INT DEFAULT 0,        -- Nivel de gravedad (1 a 5)
    fin_baneo DATETIME NULL,          -- Fecha exacta donde expira el baneo
    suscripcion VARCHAR(20) DEFAULT 'FREE',
    estado_presencia VARCHAR(20) DEFAULT 'Offline' -- Para mostrar si está conectado
);

-- TABLA VIDEOJUEGOS: Catálogo de productos disponibles
CREATE TABLE videojuegos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(100) NOT NULL,
    tematica VARCHAR(50),             -- Género (Acción, RPG, Deportes...)
    coste DECIMAL(10, 2),             -- Precio (0.00 para Free to Play)
    espacio_gb DECIMAL(10, 2),        -- Tamaño en disco
    online TINYINT(1),                -- 1 = Tiene Online, 0 = Solo Local
    jugadores INT,                    -- Nº máx de jugadores
    imagen_url VARCHAR(500),          -- URL de la carátula (Vertical)
    imagen_fondo_url VARCHAR(500)     -- URL del banner (Horizontal) para la Home
);

-- TABLA BIBLIOTECA: Relación N:M (Usuarios <-> Videojuegos)
-- Registra qué juegos ha comprado cada usuario y si los ha instalado.
CREATE TABLE biblioteca (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    id_videojuego INT NOT NULL,
    fecha_compra DATETIME DEFAULT CURRENT_TIMESTAMP,
    descargado TINYINT DEFAULT 0,     -- 0 = Comprado (Nube), 1 = Instalado (Local)
    -- Claves foráneas con borrado en cascada (si se borra user, se borra su biblioteca)
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (id_videojuego) REFERENCES videojuegos(id) ON DELETE CASCADE
);

-- TABLA LOG_ACTIVIDAD: Auditoría para acciones de administradores
CREATE TABLE log_actividad (
    id_log INT AUTO_INCREMENT PRIMARY KEY,
    id_admin INT NOT NULL,            -- Quién hizo la acción
    accion VARCHAR(50),               -- Qué hizo (BANEO, EDICION...)
    descripcion TEXT,                 -- Detalles extra
    fecha_hora DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_admin) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- TABLA APELACIONES: Mensajes de usuarios baneados pidiendo perdón
CREATE TABLE apelaciones (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    username VARCHAR(50),
    mensaje TEXT,                     -- La excusa del usuario
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- TABLA SOPORTE: Tickets de incidencias técnicas
CREATE TABLE soporte_tickets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    motivo VARCHAR(100),
    mensaje TEXT,
    estado VARCHAR(20) DEFAULT 'ABIERTO', -- ABIERTO, EN_PROCESO, RESUELTO
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- TABLA AMISTADES: Sistema social (Lista de amigos)
CREATE TABLE amistades (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario1 INT NOT NULL,
    id_usuario2 INT NOT NULL,
    estado VARCHAR(20) DEFAULT 'PENDIENTE', -- PENDIENTE, ACEPTADA
    fecha_amistad DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario1) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (id_usuario2) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- TABLA CHAT: Historial de mensajes entre amigos
CREATE TABLE chat_mensajes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_remitente INT NOT NULL,
    id_destinatario INT NOT NULL,
    mensaje TEXT NOT NULL,
    leido TINYINT(1) DEFAULT 0,       -- 0 = No leído, 1 = Leído
    fecha_envio DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_remitente) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (id_destinatario) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- ==========================================================
-- 3. CARGA DE DATOS INICIALES (DML)
-- ==========================================================

-- A) USUARIOS DE SISTEMA Y PRUEBA
-- ----------------------------------------------------------
-- Super Administrador
INSERT INTO usuarios (username, password, email, rol, activo, suscripcion)
VALUES ('admin', 'admin123', 'admin@akay.com', 'ADMIN', 1, 'VIP');

-- Usuario Estándar
INSERT INTO usuarios (username, password, email, rol, activo)
VALUES ('user', '1234', 'user@email.com', 'USER', 1);

-- Usuarios con diferentes roles administrativos
INSERT INTO usuarios (username, password, email, rol, activo) VALUES 
('SuperAdmin', '1234', 'super@akay.com', 'SUPERADMIN', 1),
('adminJ', '1234', 'games@akay.com', 'GAME_ADMIN', 1),
('adminS', '1234', 'support@akay.com', 'SUPPORT_ADMIN', 1),
('adminU', '1234', 'mod@akay.com', 'USER_ADMIN', 1);

-- Usuarios de prueba para verificar el SISTEMA DE BANEOS
-- 1. Usuario Legal
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Ana', 'Limpia', 'JugadorLegal', '1234', 'ana@test.com', 'USER', 1, 0, NULL);

-- 2. Baneado Nivel 1 (24h)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Berto', 'Leve', 'Toxic_Nvl1', '1234', 'berto@test.com', 'USER', 0, 1, DATE_ADD(NOW(), INTERVAL 1 DAY));

-- 3. Baneado Nivel 2 (3 Días)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Carlos', 'Medio', 'Campero_Nvl2', '1234', 'carlos@test.com', 'USER', 0, 2, DATE_ADD(NOW(), INTERVAL 3 DAY));

-- 4. Baneado Nivel 3 (1 Semana)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Daniela', 'Grave', 'Troll_Nvl3', '1234', 'dani@test.com', 'USER', 0, 3, DATE_ADD(NOW(), INTERVAL 7 DAY));

-- 5. Baneado Nivel 4 (1 Mes)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Edu', 'Muy Grave', 'Cheater_Nvl4', '1234', 'edu@test.com', 'USER', 0, 4, DATE_ADD(NOW(), INTERVAL 1 MONTH));

-- 6. Baneado Nivel 5 (Permanente - Año 9999)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Fede', 'Hacker', 'Hacker_Perm', '1234', 'fede@test.com', 'USER', 0, 5, '9999-12-31 23:59:59');

-- 7. Ex-Baneado (Ya debería poder entrar)
INSERT INTO usuarios (nombre, apellidos, username, password, email, rol, activo, grado_baneo, fin_baneo)
VALUES ('Gabi', 'Perdonado', 'Ex_Baneado', '1234', 'gabi@test.com', 'USER', 0, 1, DATE_SUB(NOW(), INTERVAL 1 DAY));


-- B) INTERACCIONES SOCIALES DE PRUEBA
-- ----------------------------------------------------------
-- Amistad entre Admin(1) y User(2)
INSERT INTO amistades (id_usuario1, id_usuario2, estado) VALUES (1, 2, 'ACEPTADA');

-- Chat de prueba
INSERT INTO chat_mensajes (id_remitente, id_destinatario, mensaje) VALUES 
(1, 2, 'Hola, ¿te hace una partida al LOL?'),
(2, 1, 'Claro, dame 5 minutos que entro.'),
(1, 2, 'Perfecto, te espero en el lobby.');

-- Ticket de soporte de prueba
INSERT INTO soporte_tickets (id_usuario, motivo, mensaje) 
VALUES (2, 'Error de conexión', 'No puedo entrar al servidor de GTA V desde ayer.');


-- C) CATÁLOGO DE VIDEOJUEGOS
-- ----------------------------------------------------------
INSERT INTO videojuegos (titulo, tematica, coste, espacio_gb, online, jugadores, imagen_url, imagen_fondo_url) VALUES 
('Grand Theft Auto V', 'Acción', 29.99, 110.0, 1, 30, 
 'https://m.media-amazon.com/images/I/51MFu2e82VL._AC_UF894,1000_QL80_.jpg', 
 'https://wallpapers.com/images/featured-full/imagenes-de-grand-theft-auto-v-naej4yiap4gnxh2o.jpg'),

('EA FC 24', 'Deportes', 69.99, 50.0, 1, 4, 
 'https://e00-marca.uecdn.es/assets/multimedia/imagenes/2023/07/10/16890010411401.jpg', 
 'https://assetsio.gnwcdn.com/eafc.png?width=690&quality=85&format=jpg&auto=webp'),

('Fortnite', 'Battle Royale', 0.00, 35.0, 1, 100, 
 'https://i.pinimg.com/736x/8f/16/e9/8f16e97ab5cc7873debc229c7a527a07.jpg', 
 'https://www.cecarm.com/servlet/integra.servlets.Imagenes?METHOD=VERIMAGEN_164316&nombre=fortnite-portada-pc.jpg'),

('Minecraft', 'Aventura', 19.95, 1.5, 1, 10, 
 'https://i.pinimg.com/originals/8d/85/4f/8d854f2f5e92e8c9d6ce7c8d7b4ea06c.jpg', 
 'https://phantom.estaticos-marca.com/d42b346684acc981057cbb783008d869/resize/660/f/webp/assets/multimedia/imagenes/2024/04/03/17121424603596.jpg'),

('Call of Duty: MW3', 'Shooter', 79.99, 150.0, 1, 12, 
 'https://i.3djuegos.com/juegos/19077/call_of_duty_modern_warfare_3__2023_/fotos/ficha/call_of_duty_modern_warfare_3__2023_-5829139.jpg', 
 'https://s2.abcstatics.com/abc/www/multimedia/tecnologia/2023/11/15/mw3-RJo0CaIbI8dC1T6AZlCPb6H-1200x840@abc.jpg'),

('God of War', 'Acción', 49.99, 70.0, 0, 1, 
 'https://m.media-amazon.com/images/I/61LJWSvJGEL._AC_UF894,1000_QL80_.jpg', 
 'https://media.rawg.io/media/games/4be/4be6a6ad0364751a96229c56bf69be59.jpg'),

('League of Legends', 'MOBA', 0.00, 20.0, 1, 10, 
 'https://cdn1.epicgames.com/offer/24b9b5e323bc40eea252a10cdd3b2f10/EGS_LeagueofLegends_RiotGames_S2_1200x1600-112729f9da450fe377e11d40029c4831', 
 'https://phantom.estaticos-marca.com/ad7e44d8a02d5ea8de4a01a87cc5c387/crop/0x0/1980x1112/resize/660/f/webp/assets/multimedia/imagenes/2022/03/16/16474267987028.jpg'),

('The Witcher 3', 'RPG', 29.99, 60.0, 0, 1, 
 'https://i.3djuegos.com/juegos/9592/the_witcher_3/fotos/ficha/the_witcher_3-2546814.webp', 
  'https://media.rawg.io/media/games/618/618c2031a07bbff6b4f611f10b6bcdbc.jpg'),

('Cyberpunk 2077', 'RPG', 59.99, 75.0, 0, 1, 
 'https://wallpapers.com/images/featured/cyberpunk-2077-q0o5txv6a3pqp7a9.jpg', 
 'https://media.rawg.io/media/games/26d/26d4437715bee60138dab4a7c8c59c92.jpg'),

('Elden Ring', 'RPG', 59.99, 60.0, 1, 4, 
 'https://upload.wikimedia.org/wikipedia/en/b/b9/Elden_Ring_Box_art.jpg', 
 'https://wallpapers.com/images/featured/elden-ring-6r85th0gnhifsqd0.jpg');

-- ==========================================================
-- FIN DEL SCRIPT
-- ==========================================================
